(window.webpackJsonp=window.webpackJsonp||[]).push([[81],{"./app/common/lib/util/non-public-fields-filter.ts":function(t,n,e){"use strict";e.r(n),e.d(n,"useNonPublicIfAvailable",(function(){return i}));var i=function(t,n){return t.nonPublic&&t.nonPublic[n]?t.nonPublic[n]:t[n]}},"./app/scripts/controller/inviteAcceptPage.js":function(t,n,e){function i(t,n){return function(t){if(Array.isArray(t))return t}(t)||function(t,n){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(t)))return;var e=[],i=!0,r=!1,o=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(e.push(a.value),!n||e.length!==n);i=!0);}catch(t){r=!0,o=t}finally{try{i||null==s.return||s.return()}finally{if(r)throw o}}return e}(t,n)||function(t,n){if(!t)return;if("string"==typeof t)return r(t,n);var e=Object.prototype.toString.call(t).slice(8,-1);"Object"===e&&t.constructor&&(e=t.constructor.name);if("Map"===e||"Set"===e)return Array.from(e);if("Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e))return r(t,n)}(t,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function r(t,n){(null==n||n>t.length)&&(n=t.length);for(var e=0,i=new Array(n);e<n;e++)i[e]=t[e];return i}var o=e("./packages/jquery/index.js"),a=e("./app/scripts/network/api-error.js"),s=e("./app/scripts/db/auth.js"),u=e("./app/scripts/network/payloads.ts").default,l=e("./node_modules/bluebird/js/browser/bluebird.js"),c=e("./app/common/lib/util/non-public-fields-filter.ts").useNonPublicIfAvailable,d=e("./app/scripts/views/organization/constants.js").InviteRestrictValues,m=e("./app/scripts/controller/navigate.js").navigate,f=e("./app/src/getSpinner.ts").getSpinner,p=function(t){var n=o.cookie("invitation")||"",e=i(Array.from(n.split(":")),3),r=e[0],a=e[1];return r!==t&&(a=null),{id:a,secret:e[2]}},h=function(t){var n=this,i=(t.id,t.loadModel),r=t.targetUrl,u=t.transferUrl,d=(t.viewType,t.apiUrl),p=t.nameFromInvite,h=t.emailRestrictionsFromInvite,v=t.managedRestrictionsFromInvite,b=t.modelName,g=e("./app/scripts/network/api-promise.js"),y=e("./app/scripts/views/invitation-link/invitation-link-view.js"),w=e("./app/scripts/views/invitation-link/request-admin-invite-view.js"),j=e("./app/scripts/lib/join-on-confirm.js"),k=e("./app/scripts/db/model-loader.js"),I=function(){return k.await("headerData").then((function(){if(!s.isLoggedIn())throw a.Unauthorized();return i()})).then((function(){var t;if(null!=(t=r()))return m(t,{trigger:!0,replace:!0});throw a.Unauthorized()}))},_=null!=d?g({url:d,type:"get"}):l.reject(a.NotFound());return l.using(f(),(function(){return o("#content").html('<div class="spinner loading"></div>'),j.autoJoin().then((function(){return I()})).catch(a.NotFound,a.Unauthorized,a.Unconfirmed,(function(){n.clearPreviousView();var t=s.me();return null!=t&&n.setViewType(t),n.showHeader(),l.props({invite:_,member:s.isLoggedIn()?k.for("top-level","loadMemberLogins",s.myId()):void 0}).then((function(e){var i,r=e.invite;return r.memberInviter.fullName=c(r.memberInviter,"fullName"),i=r.inviteeCanAccept?n.topLevelView(y,t,{inviter:r.memberInviter,name:p(r),emailRestrictions:h(r),allowManagedMembers:v(r),inviteIdEnterprise:null!=r.organization?r.organization.idEnterprise:void 0,transferUrl:"function"==typeof u?u():void 0,willJoinOnConfirm:j.inQueue(d),fxJoin:()=>g({method:"post",url:d}).then(I),fxQueueJoin:()=>j.add(d),modelName:b}):n.topLevelView(w,t,{memberInviter:r.memberInviter}),o("#content").html(i.render().el)}))}))}))};function v(t,n){return null!=t?n(t):void 0}t.exports={boardInvitationPage(){var t=this,n=p("board"),i=n.id,r=n.secret,o=e("./app/scripts/db/model-cache.js"),l=e("./app/scripts/db/model-loader.js"),c=i&&r?"/1/board/".concat(i,"/invitationSecret/").concat(r):null;h.call(this,{loadModel(){if(i)return l.for("top-level","loadBoardData",i,u.currentBoardMinimal);throw a.BadRequest("invalid board shortLink")},targetUrl:function(){var n;return null!=(n=o.get("Board",i))&&n.isMember(s.me())?t.getBoardUrl(n):null},viewType:"board-invitation-link",apiUrl:c,nameFromInvite:t=>t.board.name,emailRestrictionsFromInvite:()=>[],managedRestrictionsFromInvite:()=>[],modelName:"Board"}).catch(a,(function(){return t.displayErrorPage({errorType:"boardInvitationNotFound"})})).done()},teamInvitationPage(){var t=this,n=p("organization"),i=n.id,r=n.secret,o=e("./app/scripts/db/model-cache.js"),u=e("./app/scripts/db/model-loader.js"),l=i&&r?"/1/organization/".concat(i,"/invitationSecret/").concat(r):null;h.call(this,{loadModel(){if(i)return u.for("top-level","loadOrganizationData",i);throw a.BadRequest("invalid orgname")},targetUrl:function(){var n;return null!=(n=o.findOne("Organization",(function(t){return t.get("name")===i})))&&n.isMember(s.me())?t.getOrganizationUrl(i):null},transferUrl:()=>"/".concat(i,"/transfer-account"),viewType:"org-invitation-link",apiUrl:l,nameFromInvite:t=>t.organization.displayName,emailRestrictionsFromInvite(t){var n;return null!=(n=v(null!=t.organization.prefs?t.organization.prefs.orgInviteRestrict:void 0,(function(t){return t.filter((function(t){return!Object.values(d).includes(t)}))})))?n:[]},managedRestrictionsFromInvite(t){var n;return null!=(n=v(null!=t.organization.prefs?t.organization.prefs.orgInviteRestrict:void 0,(function(t){return t.some((function(t){return[d.MANAGED,d.MANAGED_OR_DOMAIN].includes(t)}))})))&&n},modelName:"Team"}).catch(a,(function(n){return t.displayErrorPage({errorType:"orgInvitationNotFound"})})).done()}}},"./app/scripts/views/invitation-link/invitation-link-view.js":function(t,n,e){function i(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}function r(t,n){for(var e=0;e<n.length;e++){var i=n[e];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function o(t,n){return(o=Object.setPrototypeOf||function(t,n){return t.__proto__=n,t})(t,n)}function a(t,n){return!n||"object"!=typeof n&&"function"!=typeof n?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):n}function s(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}function u(t){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}var l=e("./app/scripts/network/api-error.js"),c=e("./app/scripts/db/auth.js"),d=e("./packages/browser/index.ts"),m=e("./packages/keybindings/index.ts").isSubmitEvent,f=e("./app/scripts/lib/localize-server-error.js"),p=e("./app/scripts/views/lib/pop-up-window.js"),h=e("./app/scripts/views/internal/teacup-with-helpers.js")("invitation_link"),v=e("./app/scripts/lib/util/index.js"),b=e("./app/scripts/views/internal/view.js"),g=e("./node_modules/underscore/underscore.js"),y=e("./packages/jquery/index.js"),w=e("./packages/storage/index.ts").TrelloStorage,j=e("./packages/feature-flag-client/index.ts").featureFlagClient,k=e("./packages/config/index.ts"),I=k.identityBaseUrl,_=k.siteDomain,x=function(t){return/^\*@[^\*]+$/.test(t)?t.replace(/^\*@/,""):null},R=h.renderable((function(t){var n=t.me,e=t.isLoggedIn,i=t.isConfirmed,r=t.isValidEmail,o=t.hasValidManagedStatus,a=t.returnUrl,s=t.inviter,u=t.name,l=t.requiredDomain,c=t.firstDomain,d=t.emailRestrictions,m=t.pendingEmail,f=t.willJoinOnConfirm,p=t.transferUrl,v=t.modelName;h.div(".invitation-link-description",(function(){return h.format("youve-been-invited",{inviterName:s.fullName,name:u})})),m?h.p(".invitation-link-explanation",(function(){return h.format("waiting-for-you-to-click-on-the-link-we-sent-to-email",{email:m})})):e?r||o?i?(h.div(".invitation-link-options",(function(){return h.button(".nch-button.nch-button--primary.js-join",(function(){return"Board"===v?h.format("join-board"):"Team"===v?h.format("join-team"):void 0}))})),h.div(".little-message",(function(){if(h.format("different-current-user",{currentUserName:n.get("fullName")}),j.get("aa4a.account-switcher",!1)&&w.get("accountSwitcherAccountAdded")){var t=new URLSearchParams({prompt:"select_account",continue:"".concat(_,"/auth/atlassian/callback?returnUrl=").concat(a),application:"trello"}).toString();return h.a({href:"".concat(I,"/login?").concat(t)},(function(){return h.format("switch-accounts")}))}return h.a({href:"/login?reauthenticate=1&returnUrl=".concat(encodeURIComponent(a))},(function(){return h.format("switch-accounts")}))}))):(h.p(".invitation-link-explanation.js-you-need-to-confirm",(function(){return h.format("before-you-can-join-you-ll-need-to-confirm-your-email-address")})),f||(h.p(".invitation-link-explanation.js-will-join-on-confirm.hide",(function(){return h.format("youll-be-added-as-soon-as-you-confirm-your-email")})),h.div(".invitation-link-options",(function(){return h.button(".nch-button.nch-button--primary.js-join-on-confirm",(function(){return h.format("join-after-i-confirm-my-email")}))})))):(l?(h.p(".invitation-link-explanation",(function(){return h.format("to-join-this-team-you-need-to-confirm-an-email-from-domain",{domain:l})})),h.h2(".add-email-to-your-account-heading",(function(){return h.format("add-email-to-your-account")})),h.div(".invitation-link-add-email",(function(){return h.input(".invitation-link-add-email-prefix.js-email-prefix-to-add",{placeholder:h.l("yourname"),"data-domain":l}),h.span(".invitation-link-add-email-domain",(function(){return h.text("@".concat(l))}))}))):(h.p(".invitation-link-explanation",(function(){return h.format("to-join-this-team-you-need-to-confirm-an-email-matching-one-of-the-following")})),h.ul((function(){return Array.from(d).map((function(t){return h.li((function(){return h.text(t)}))}))})),h.h2(".add-email-to-your-account-heading",(function(){return h.format("add-email-to-your-account")})),h.div(".invitation-link-add-email",(function(){var t=c?h.l("yourname-at-domain",{domain:c}):void 0;return h.input(".invitation-link-add-email.js-email-to-add",{placeholder:t})}))),h.div(".invitation-link-options",(function(){if(h.div((function(){return h.a(".nch-button.nch-button--primary.js-add-email",{href:"#"},(function(){return h.format("add-email")}))})),h.div(".little-message",(function(){return h.a({href:"/login?reauthenticate=1&returnUrl=".concat(encodeURIComponent(a))},(function(){return h.format("switch-accounts")}))})),j.get("aa4a.account-switcher",!1)&&w.get("accountSwitcherAccountAdded")){var t=new URLSearchParams({prompt:"select_account",continue:"".concat(_,"/auth/atlassian/callback?returnUrl=").concat(a),application:"trello"}).toString();return h.a({href:"".concat(I,"/login?").concat(t)},(function(){return h.format("switch-accounts")}))}return h.a({href:"/login?reauthenticate=1&returnUrl=".concat(encodeURIComponent(a))},(function(){return h.format("switch-accounts")}))}))):(h.p(".invitation-link-explanation",(function(){return"Board"===v?h.format("before-you-can-join-you-ll-need-a-trello-account-board"):"Team"===v?h.format("before-you-can-join-you-ll-need-a-trello-account-team"):void 0})),(l||d.length>0)&&(l?h.p((function(){return h.format("note-this-team-requires-you-log-in-with-an-email-from-domain",{domain:l})})):(h.p((function(){return h.format("note-this-team-requires-you-log-in-with-an-email-matching-one-of-the-following")})),h.ul((function(){return Array.from(d).map((function(t){return h.li((function(){return h.text(t)}))}))})))),h.div(".invitation-link-options",(function(){return h.button(".nch-button.nch-button--primary.js-signup",(function(){return h.format("sign-up")})),h.button(".button.js-login",(function(){return h.format("log-in")}))})),h.div(".invitation-link-options-learn-more",(function(){return h.a(".quiet",{href:"/tour",target:"tour"},(function(){return h.format("learn-more-about-trello")}))}))),h.p(".error.js-deactivated.hide",(function(){return h.format("unfortunately-this-invitation-link-has-been-deactivated")})),h.p(".error.js-only-team-members.hide",(function(){return h.format("only-team-members-can-join-this-board")})),h.p(".error.js-only-managed-members.hide",(function(){return h.format("only-managed-members-can-join-this-board")})),h.p(".error.js-only-team-or-managed-members.hide",(function(){return h.format("only-team-or-managed-members-can-join-this-board")})),h.div(".error.js-must-join-enterprise.hide",(function(){return h.p((function(){return h.format("before-you-can-join-this-team-you-must-join-the-enterprise-it-belongs-to")})),h.p((function(){return h.a(".nch-button.nch-button--primary",{href:p},(function(){return h.format("transfer-account")}))}))})),h.p(".error.js-error.hide",(function(){}))})),U=function(t){!function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(n&&n.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),n&&o(t,n)}(k,t);var n,e,b,w,j=(n=k,function(){var t,e=u(n);if(s()){var i=u(this).constructor;t=Reflect.construct(e,arguments,i)}else t=e.apply(this,arguments);return a(this,t)});function k(){return i(this,k),j.apply(this,arguments)}return e=k,w=[{key:"initClass",value:function(){this.prototype.className="invitation-link",this.prototype.events={"click .js-join"(t){var n=this;return this._disableJoin(),this.fxJoin().catch(l.NotFound,(function(t){return n.$(".js-deactivated").removeClass("hide")})).catch(l.Other,(function(t){if(/organization restricts invites/.test(t.message))return n.$(".js-only-team-members").removeClass("hide");if(/invites restricted to managed members/.test(t.message))return n.$(".js-only-managed-members").removeClass("hide");if(/invites restricted to org or managed members/.test(t.message))return n.$(".js-only-team-or-managed-members").removeClass("hide");throw t})).catch(l.Conflict,(function(t){return n.$(".js-must-join-enterprise").removeClass("hide")})).catch(l,(function(t){var e=f(t);return n.$(".js-error").text(e).removeClass("hide")})).done()},"click .js-add-email"(t){var n=this;this.$(".js-email-to-add,.js-email-prefix-to-add").prop("disabled",!0),this.$(".js-add-email").prop("disabled",!0).addClass("disabled");var e=this._getEmail();return this.model.run("logins",{email:e},(function(t){n.pendingEmail=e,n.render()}))},"input .js-email-to-add":"updateButton","input .js-email-prefix-to-add":"updateButton","keydown .js-email-prefix-to-add,.js-email-to-add"(t){if(m(t))return this.$(".js-add-email:not(:disabled)").click()},"click .js-join-on-confirm"(t){return this._queueAutoJoin(),this.$(".js-join-on-confirm,.js-you-need-to-confirm").addClass("hide"),this.$(".js-will-join-on-confirm").removeClass("hide")},"click .js-signup"(t){this._queueAutoJoin();var n=this._requiredDomain(),e=n?h.l("yourname-at-domain",{domain:n}):"",i="/signup?"+y.param({returnUrl:d.isEmbeddedDocument()?"/embed/signup":this._returnUrl(),confirmReturnUrl:this._returnUrl(),email:e});return d.isEmbeddedDocument()?new p(i).open():window.location=i},"click .js-login"(t){this._queueAutoJoin();var n=d.isEmbeddedDocument()?"/embed/login":this._returnUrl(),e="/login?"+y.param({returnUrl:n});return d.isEmbeddedDocument()?new p(e).open():window.location=e}}}}],(b=[{key:"_disableJoin",value:function(){return this.$(".js-join").addClass("disabled").prop("disabled",!0)}},{key:"initialize",value:function(t){var n,e=this,i=t.fxJoin,r=t.fxQueueJoin,o=t.inviter,a=t.name,s=t.emailRestrictions,u=t.transferUrl,l=t.willJoinOnConfirm,d=t.modelName,m=t.allowManagedMembers,f=t.inviteIdEnterprise;if(this.fxJoin=i,this.fxQueueJoin=r,this.inviter=o,this.name=a,this.emailRestrictions=s,this.transferUrl=u,this.willJoinOnConfirm=l,this.modelName=d,this.allowManagedMembers=m,this.inviteIdEnterprise=f,null!=(n=c.me()))return this.listenTo(n,"change:confirmed change:logins",(function(){return e.$(".js-join").addClass("disabled"),setTimeout((function(){return window.location.reload()}),1e3)}))}},{key:"updateButton",value:function(){var t=this._isValidEmail(this._getEmail());return this.$(".js-add-email").prop("disabled",!t).toggleClass("disabled",!t)}},{key:"_queueAutoJoin",value:function(){return this.fxQueueJoin()}},{key:"_getEmail",value:function(){var t=this.$(".js-email-to-add"),n=this.$(".js-email-prefix-to-add");return t.length?t.val():n.length?"".concat(n.val(),"@").concat(n.attr("data-domain")):void 0}},{key:"_isValidEmail",value:function(t){return 0===this.emailRestrictions.length||g.any(this.emailRestrictions,(function(n){return new RegExp("^".concat(v.escapeForRegex(n).replace(/\\\*/g,"[^@]*"),"$")).test(t)}))}},{key:"_hasValidManagedStatus",value:function(t){return this.allowManagedMembers&&this.inviteIdEnterprise&&this.inviteIdEnterprise===t}},{key:"_returnUrl",value:function(){return window.location.pathname}},{key:"_requiredDomain",value:function(){return 1===this.emailRestrictions.length&&x(this.emailRestrictions[0])}},{key:"render",value:function(){var t=this,n=c.me(),e=c.isLoggedIn(),i=null!=n?n.get("confirmed"):void 0,r=e&&g.chain(n.get("logins")).pluck("email").any(this._isValidEmail.bind(this)).value(),o=e&&this._hasValidManagedStatus(n.get("idEnterprise")),a=this._requiredDomain(),s=g.chain(this.emailRestrictions).map(x).compact().first().value();return this.$el.html(R({me:n,emailRestrictions:this.emailRestrictions,requiredDomain:a,firstDomain:s,inviter:this.inviter,name:this.name,isConfirmed:i,isLoggedIn:e,isValidEmail:r,hasValidManagedStatus:o,pendingEmail:this.pendingEmail,returnUrl:this._returnUrl(),transferUrl:this.transferUrl,willJoinOnConfirm:this.willJoinOnConfirm,modelName:this.modelName})),this.updateButton(),this.defer((function(){return t.$(".js-email-prefix-to-add,.js-email-to-add").focus().select()})),this}}])&&r(e.prototype,b),w&&r(e,w),k}(b);U.initClass(),t.exports=U},"./app/scripts/views/invitation-link/request-admin-invite-view.js":function(t,n,e){function i(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}function r(t,n){for(var e=0;e<n.length;e++){var i=n[e];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function o(t,n){return(o=Object.setPrototypeOf||function(t,n){return t.__proto__=n,t})(t,n)}function a(t,n){return!n||"object"!=typeof n&&"function"!=typeof n?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):n}function s(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}function u(t){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}var l=e("./app/scripts/views/internal/view.js"),c=e("./app/scripts/views/internal/teacup-with-helpers.js")("request_admin_invite"),d=c.renderable((function(t){var n=t.memberInviter;return c.div(".invitation-link-description.request-admin-invite",(function(){return c.h2((function(){return c.format("lets-add-you-to-this-board-in-another-way")})),c.p(".invitation-link-explanation",(function(){return c.format("has-invited-you-to-this-board",{memberInviterName:n.fullName})}))}))})),m=function(t){!function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(n&&n.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),n&&o(t,n)}(f,t);var n,e,l,c,m=(n=f,function(){var t,e=u(n);if(s()){var i=u(this).constructor;t=Reflect.construct(e,arguments,i)}else t=e.apply(this,arguments);return a(this,t)});function f(){return i(this,f),m.apply(this,arguments)}return e=f,c=[{key:"initClass",value:function(){this.prototype.className="invitation-link"}}],(l=[{key:"initialize",value:function(t){var n=t.memberInviter;this.memberInviter=n}},{key:"render",value:function(){return this.$el.html(d({memberInviter:this.memberInviter})),this}}])&&r(e.prototype,l),c&&r(e,c),f}(l);m.initClass(),t.exports=m},"./app/scripts/views/lib/pop-up-window.js":function(t,n){function e(t,n){for(var e=0;e<n.length;e++){var i=n[e];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}t.exports=function(){function t(n,e,i,r){!function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}(this,t),null==e&&(e="Trello"),null==i&&(i=450),null==r&&(r=700),this.url=n,this.windowName=e,this.width=i,this.height=r}var n,i,r;return n=t,(i=[{key:"open",value:function(){var t=window.screenX+(window.innerWidth-this.width)/2,n=window.screenY+(window.innerHeight-this.height)/2;return this.popup=window.open(this.url,this.windowName,"width=".concat(this.width,",height=").concat(this.height,",top=").concat(n,",left=").concat(t))}}])&&e(n.prototype,i),r&&e(n,r),t}()}}]);
//# sourceMappingURL=invite-accept-page.a264d7551f5abb8f7792.js.map